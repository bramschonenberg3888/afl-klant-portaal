// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum UserRole {
  ADMIN
  CONSULTANT
  ACCOUNT_MANAGER
  CLIENT
}

enum Layer {
  RUIMTE_INRICHTING
  WERKWIJZE_PROCESSEN
  ORGANISATIE_BESTURING
}

enum Perspective {
  EFFICIENT
  VEILIG
}

enum RAGScore {
  ROOD
  ORANJE
  GROEN
}

enum ScanStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  ARCHIVED
}

enum ImpactLevel {
  NONE
  LOW
  MEDIUM
  HIGH
}

enum Timeframe {
  QUICK_WIN
  DAYS_30
  DAYS_60
  DAYS_90
}

enum RoadmapStatus {
  TODO
  IN_PROGRESS
  DONE
  DEFERRED
}

enum ActionStatus {
  TODO
  IN_PROGRESS
  DONE
  DEFERRED
  CANCELLED
}

enum ActionPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DocumentCategory {
  QUICKSCAN_REPORT
  COMPLIANCE
  SAFETY
  WORK_INSTRUCTIONS
  CERTIFICATES
  TRAINING
  TEMPLATE
  OTHER
}

enum AssessmentStatus {
  IN_PROGRESS
  COMPLETED
}

enum QuoteStatus {
  NEW
  CONTACTED
  QUOTED
  CLOSED
}

// ─── NextAuth.js Models ─────────────────────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  globalRole     UserRole  @default(CLIENT)

  accounts      Account[]
  sessions      Session[]
  posts         Post[]
  conversations Conversation[]
  organizations OrganizationUser[]
  uploads       Upload[]

  // QuickScan relations
  consultantScans     QuickScan[]   @relation("ConsultantScans")
  accountManagerScans QuickScan[]   @relation("AccountManagerScans")
  ownedRoadmapItems   RoadmapItem[]

  // Action relations
  assignedActions Action[] @relation("AssignedActions")
  reportedActions Action[] @relation("ReportedActions")
  actionComments  ActionComment[]

  // Document relations
  clientDocuments ClientDocument[]

  // Assessment relations
  assessmentResponses AssessmentResponse[]
  createdAssessments  AssessmentResponse[] @relation("CreatedAssessments")

  // Product relations
  quoteRequests QuoteRequest[]

  // Audit relations
  auditLogs AuditLog[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Multi-Tenancy ──────────────────────────────────────────────────────────

model Organization {
  id         String   @id @default(cuid())
  name       String
  slug       String   @unique
  address    String?
  city       String?
  postalCode String?
  phone      String?
  logoUrl    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users           OrganizationUser[]
  uploads         Upload[]
  quickScans      QuickScan[]
  actions         Action[]
  clientDocuments ClientDocument[]
  assessments     AssessmentResponse[]
  quoteRequests   QuoteRequest[]
}

model OrganizationUser {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           UserRole @default(CLIENT)
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Upload {
  id             String   @id @default(cuid())
  fileName       String
  fileUrl        String
  fileSize       Int
  mimeType       String
  uploadedById   String
  organizationId String
  createdAt      DateTime @default(now())

  uploadedBy   User         @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ─── Example Models ─────────────────────────────────────────────────────────

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── RAG Knowledge Base ─────────────────────────────────────────────────────

model Document {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  sourceUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  chunks    DocumentChunk[]
}

model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  content    String   @db.Text
  chunkIndex Int
  embedding  Unsupported("vector(1536)")?
  createdAt  DateTime @default(now())

  @@index([documentId])
}

// ─── Chat ───────────────────────────────────────────────────────────────────

model Conversation {
  id        String    @id @default(cuid())
  userId    String?
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  title     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  messages  Message[]
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // "user" | "assistant"
  content        String       @db.Text
  sources        String?      @db.Text // JSON array of source URLs
  feedback       String?      // "positive" | "negative"
  createdAt      DateTime     @default(now())

  @@index([conversationId])
}

// ─── QuickScan ──────────────────────────────────────────────────────────────

model QuickScan {
  id                String     @id @default(cuid())
  organizationId    String
  consultantId      String?
  accountManagerId  String?
  title             String
  scanDate          DateTime   @default(now())
  status            ScanStatus @default(DRAFT)
  overallEfficiency RAGScore?
  overallSafety     RAGScore?
  summary           String?    @db.Text
  managementSummary String?    @db.Text
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  consultant     User?        @relation("ConsultantScans", fields: [consultantId], references: [id], onDelete: SetNull)
  accountManager User?        @relation("AccountManagerScans", fields: [accountManagerId], references: [id], onDelete: SetNull)

  cells        ScanCell[]
  findings     ScanFinding[]
  roadmapItems RoadmapItem[]

  @@index([organizationId])
}

model ScanCell {
  id          String      @id @default(cuid())
  scanId      String
  layer       Layer
  perspective Perspective
  score       RAGScore?
  summary     String?     @db.Text

  scan     QuickScan     @relation(fields: [scanId], references: [id], onDelete: Cascade)
  findings ScanFinding[]

  @@unique([scanId, layer, perspective])
}

model ScanFinding {
  id               String      @id @default(cuid())
  scanId           String
  cellId           String
  title            String
  description      String?     @db.Text
  efficiencyImpact ImpactLevel @default(NONE)
  safetyImpact     ImpactLevel @default(NONE)
  recommendation   String?     @db.Text
  photoUrls        String[]
  sortOrder        Int         @default(0)
  impactScore      Int?
  effortScore      Int?

  scan QuickScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
  cell ScanCell  @relation(fields: [cellId], references: [id], onDelete: Cascade)

  actions              Action[]
  productRecommendations ProductRecommendation[]

  @@index([scanId])
  @@index([cellId])
}

model RoadmapItem {
  id          String        @id @default(cuid())
  scanId      String
  title       String
  description String?       @db.Text
  timeframe   Timeframe
  priority    Int           @default(0)
  status      RoadmapStatus @default(TODO)
  ownerId     String?
  dueDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  scan  QuickScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
  owner User?     @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([scanId])
}

// ─── Actions ────────────────────────────────────────────────────────────────

model Action {
  id             String         @id @default(cuid())
  organizationId String
  title          String
  description    String?        @db.Text
  layer          Layer?
  perspective    Perspective?
  status         ActionStatus   @default(TODO)
  priority       ActionPriority @default(MEDIUM)
  assigneeId     String?
  reporterId     String?
  dueDate        DateTime?
  completedAt    DateTime?
  photoUrls      String[]
  findingId      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignee     User?        @relation("AssignedActions", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter     User?        @relation("ReportedActions", fields: [reporterId], references: [id], onDelete: SetNull)
  finding      ScanFinding? @relation(fields: [findingId], references: [id], onDelete: SetNull)

  comments               ActionComment[]
  productRecommendations ProductRecommendation[]

  @@index([organizationId])
  @@index([assigneeId])
}

model ActionComment {
  id        String   @id @default(cuid())
  actionId  String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())

  action Action @relation(fields: [actionId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([actionId])
}

// ─── Client Documents ───────────────────────────────────────────────────────

model ClientDocument {
  id             String           @id @default(cuid())
  organizationId String
  title          String
  description    String?          @db.Text
  category       DocumentCategory @default(OTHER)
  fileUrl        String
  fileName       String
  fileSize       Int
  mimeType       String
  version        Int              @default(1)
  parentId       String?
  expiresAt      DateTime?
  isTemplate     Boolean          @default(false)
  uploadedById   String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedBy   User            @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  parent       ClientDocument? @relation("DocumentVersions", fields: [parentId], references: [id], onDelete: SetNull)
  versions     ClientDocument[] @relation("DocumentVersions")

  @@index([organizationId])
}

// ─── Assessment ─────────────────────────────────────────────────────────────

model AssessmentTemplate {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  isActive    Boolean  @default(true)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions AssessmentQuestion[]
  responses AssessmentResponse[]
}

model AssessmentQuestion {
  id           String      @id @default(cuid())
  templateId   String
  layer        Layer
  perspective  Perspective
  questionText String
  helpText     String?     @db.Text
  sortOrder    Int         @default(0)
  weight       Float       @default(1.0)

  template AssessmentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  answers  AssessmentAnswer[]

  @@index([templateId])
}

model AssessmentResponse {
  id             String           @id @default(cuid())
  templateId     String
  userId         String?
  organizationId String?
  createdById    String?
  contactName    String?
  contactEmail   String?
  contactCompany String?
  contactPhone   String?
  status         AssessmentStatus @default(IN_PROGRESS)
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  template     AssessmentTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user         User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization?        @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  createdBy    User?                @relation("CreatedAssessments", fields: [createdById], references: [id], onDelete: SetNull)
  answers      AssessmentAnswer[]
  resultCells  AssessmentResultCell[]

  @@index([templateId])
}

model AssessmentAnswer {
  id         String @id @default(cuid())
  responseId String
  questionId String
  score      Int // 1-5
  notes      String? @db.Text

  response AssessmentResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  question AssessmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([responseId, questionId])
}

model AssessmentResultCell {
  id          String      @id @default(cuid())
  responseId  String
  layer       Layer
  perspective Perspective
  score       RAGScore
  rawScore    Float

  response AssessmentResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@unique([responseId, layer, perspective])
}

// ─── Products ───────────────────────────────────────────────────────────────

model Product {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  sku         String?
  category    String?
  layer       Layer?
  imageUrl    String?
  productUrl  String?
  priceRange  String?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recommendations ProductRecommendation[]
  quoteRequests   QuoteRequest[]
}

model ProductRecommendation {
  id        String  @id @default(cuid())
  productId String
  findingId String?
  actionId  String?
  layer     Layer?
  context   String? @db.Text
  sortOrder Int     @default(0)

  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  finding ScanFinding? @relation(fields: [findingId], references: [id], onDelete: Cascade)
  action  Action?      @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model QuoteRequest {
  id             String      @id @default(cuid())
  organizationId String?
  userId         String?
  productId      String?
  contactName    String
  contactEmail   String
  contactPhone   String?
  message        String?     @db.Text
  status         QuoteStatus @default(NEW)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  product      Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
}

// ─── Benchmarking ───────────────────────────────────────────────────────────

model BenchmarkSnapshot {
  id          String   @id @default(cuid())
  generatedAt DateTime @default(now())
  totalScans  Int
  data        String   @db.Text // JSON with per-cell distribution and averages
}

// ─── Audit Logging ─────────────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // CREATE, UPDATE, DELETE, STATUS_CHANGE
  resource   String   // action, document, quickscan, finding, roadmap_item
  resourceId String
  details    String?  @db.Text // JSON with before/after or metadata
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resource, resourceId])
  @@index([createdAt])
}
